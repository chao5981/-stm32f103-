  在stm32f1系列中，定时器分为三种定时器:基本定时器，通用定时器和高级定时器。见下图：
  ![image](https://github.com/user-attachments/assets/1c5643d5-3fa3-4818-8416-0fdbd9acff0a)

  在这张图中，你会看到一系列的新名词。例如"互补输出"，"捕获/比较通道"。若你提前瞟了一眼高级TIM，你还会发现"死区"，"H桥"等这些东西。若你现在直接取查AI问这些东西，你一定会看得头大!

  这里我就先不解释，我按照我的思路去理解基本TIM和后面的高级TIM。

  首先，先附上一张基本定时器功能框图
  ![image](https://github.com/user-attachments/assets/a68d4eb7-3266-4d62-abb9-a760ec61e801)

  好，看一眼就好，不用按照野火的手册去理解，那太不好懂了，听我的思路。

  1.在前面的程序配置一些外设时(如GPIO,ADC)，都要开启时钟吧，都需要一个时钟源吧。既然是个定时器，肯定也需要一个时钟源。时钟源就由系统时钟APB总线的时钟PCLK1提供。PCLK1到这里要经过一个预分频器。这里的分频和之前的相比略有不同，如果 APB1 预分频系数等于 1，则频率不变，否则频率乘以 2。例如库函数中 APB1 预分频的系数是 2，PCLK1=36M，所以定时器时钟=36*2=72M。

  2.定时器时钟的频率已经定下来了，那如果我不想用这个频率怎么办？我还想要细分。这时候定时器内部还有一个分频器(PSC)，它能对TIMxCLK 进行 1~65536 之间的任何一个数进行分频

  好，现在来解释一下专业名词。APB1总线时钟PLCK1先分频得到定时器时钟TIMxCLK(也称内部时钟CK_INT)。然后再经过定时器内部的分频器(PSC)在进行一次分频，得到CK_CNT。

  3.都叫定时器了是不是得有个东西来数时间啊，在定时器里面有一个计数器(CNT)，最大值是65535，对于基本定时器来说，只能往上计数。

  4.那数到哪时候才停？定时器里面有一个自动重装寄存器(ARR)，当计数到这个值的时候，如果使能了中断的话，定时器就产生溢出中断。

  所以定时器的基本原理我们就可以理通了，CNT用着PCLK经过APB分频和PSC分频后的频率(CK_CNT)去计数，当计数的值达到ARR里面的值后就可以产生中断。

  知道这个后，那么中断周期我们也可以知道了，那不就是计时器(CNT)计一个数的时间乘以它总计数(ARR)吗？因此公式为1/CK_CNT*(ARR+1).因为计数器是从0开始数，所以是ARR+1；CK_CNT是频率，T=1/f。如果在中断服务程序里面设置一个变量 time，用来记录中断的次数，当到一段时间后再进行对执行一些程序。那么就可以计算出我们需要的定时时间等于：1/CK_CLK* (ARR+1)*time。

  
  看完这个过后，你有没有觉得这样的实验好像也做过？是的，只是当时用的不是定时器，用的是systick。除了不用配置结构体以外，实现的想法和结果几乎一模一样。

  那么TIM的计时功能和systick到底有什么区别呢？我就不能用systick吗

  如果你用systick做倒计时也不是不可以，毕竟systick属于Cortex-M内核内置的简易定时器，属于ARM核心外设。本质上也属于定时器。它主要干为操作系统（如FreeRTOS、uC/OS）提供精确的时基，实现任务调度；生成固定的时间中断（如1ms中断），用于裸机程序的延时函数（如HAL_Delay()）。

  和基本TIM来比，基本TIM还是能打一点，它不仅仅可以作为定时器产生中断，还可以用作其他定时器的定时。看那个最上边那个图，在触发控制器的右边引出了一个TRGO(不用鸟这个是上面意思)到DAC，这个的意思是定时器可以作为DAC采样的计时器。但是要注意的是，不是所有的TIM都可以用于其他的外设，像基本TIM基本上只能用于DAC上；通用和高级TIM就可以用在DAC,ADC和其他定时器。

  但是如果和高级TIM比，那systick就比不了了，高级TIM可以输出PWM波形和测量频率和脉宽。systick的功能也仅仅限制于定时。

  现在开始介绍一下只用于计时的结构体(时基结构体)TIM_TimeBaseInitTypeDef(在高级寄存器中还有用于输出比较结构体TIM_OCInitTypeDef，输入捕获结构体TIM_ICInitTypeDef，断路和死区结构体TIM_BDTRInitTypeDef)这个后面再说。

    1.TIM_Prescaler：定时器预分频器设置，配置的时PSC的分频值
    2.TIM_CounterMode:配置的是CNK的工作模式，即定时器计数方式，可设置为向上计数、向下计数以及中心对齐。高级控制定时器允许选择任意一种。
    3.TIM_Period：定时器周期，配置的就是自动重载寄存器 ARR 的值
    4.TIM_ClockDivision：时钟分频，设置定时器时钟 CK_INT 频率与死区发生器以及数字滤波器采样时钟频率分频比。
    5.TIM_RepetitionCounter：重复计数器，只有 8 位。

  如果只是用于定时的话，那么2，4，5都用不上，这几个我讲到高级TIM再介绍

  配置完成后初始化。
  
  接着先清除计数器的中断标志位，这个习惯要养成，这属于防御性编程。

  然后开启计时器中断和使能计时器。

  最后配置中断函数，中断函数的命名必须和中断源一致，否则无法进入中断函数。
