再stm32f103中，中断可以被分为俩种，一种是内部中断，一种是外部中断。

这一节我们只讲外部中断。

外部中断的实现需要俩个控制器共同实现，一个是NVIC(嵌套向量中断控制器);一个是EXTI(外部中断/事件控制器)。

这俩个是如何工作的呢，简单来说，NVIC是用来配置中断的优先级，并确定哪个中断先执行的。就像是51单片机中调用中断时的"interrupt x"中的"x";而EXTI是负责检测外部引脚的电平变化（如按键、GPIO 边沿触发），并生成中断请求信号给NVIC。

但是NVIC可绝没有C51中的"interrupt x"那么简单。在C51中，我们是根据"interrupt x"中的'x'去判断哪个中断优先;但是在NVIC中，他是把整个优先级分成了"抢占优先级"和"子优先级"俩个优先级。那么如何看哪个中断优先呢？抢占优先级高的就会抢占抢占优先级低的优先得到执行，如果抢占优先级相同，就比较子优先级。如果抢占优先级和子优先级都相同的话，就比较他们的硬件中断编号，编号越小，优先级越高。

让我们先看看NVIC的相关寄存器。
![image](https://github.com/user-attachments/assets/2248c2b6-d642-4fdb-aadc-da50abd4c28f)
你现在所看到的就是配置优先级的寄存器，正常的应该有16位的，但是绝大多数CM3芯片都会精简设计，以致实际上支持的优先级数减少，在F103中，只使用了高4bit。

那可是这个寄存器可不会告诉计算机哪个部分是抢占优先级哪个部分是子优先级。所以这里的分组需要我们自己调用库函数去告诉计算机

那么我们配置之后，优先级和子优先级的范围是多少？请见下图：
![image](https://github.com/user-attachments/assets/82b5ed57-5988-446d-816f-d338e4cdfc9d)


这里我们需要的是外设中断，关键是弄懂EXTI控制器是如何工作的，原理图如图所示。
![image](https://github.com/user-attachments/assets/2ca12bfc-abe3-4ee4-9ca7-9b3723444e02)
红色的是中断线，我先讲解中断线。


1.输入线连接上一个外设(例如按键等)，外设电平的变化会被输入线检测到并且传递给边沿检测电路

2.如图所示，边沿检测电路中连接着俩个寄存器上升沿触发选择寄存器 (EXTI_RTSR) 和下降沿触发选择寄存器 (EXTI_FTSR),你可以配置这个边沿检测电路选择其中一个寄存器或者俩个寄存器都选。只有来自输入线上的电平变化和你选的寄存器的电平变化一致时，才会输出有效信号。例如：你要求当按键的电平从0变化到1才能触发中断，当输入线传来的引脚信号是从1变成了0，和边沿检测电路的不一致，那么就发出无效信号，若传来的信号是从0到1，和边沿检测电路的信号一致，它才会向后面发出有效信号。

3.一个或门电路，连接着软件中断事件寄存器(EXTI_SWIER)，你可以配置使得中断的是否开启，就和C51中的中断开关类似

4.一个与门电路，连接着中断屏蔽寄存器(EXTI_IMR),和软件中断事件寄存器的作用类似，只是反了过来而已

5.将EXTI_PR寄存器内容输出到NVIC内，从而实现系统中断事件控制。

接下来我们来看事件线。

事件线的前三步和中断线一致，我们这里就不做赘述

4.也就是编号6：一个与门电路，连接着事件屏蔽寄存器(EXTI_EMR)，类似于中断屏蔽计时器。

5.也就是编号7：一个脉冲发生器，当传来有效信号1时，就会产生一个脉冲信号，这个脉冲信号可以给其他外设电路使用，比如定时器TIM、模拟数字转换器ADC等等。

至此，EXTI和NVIC的工作原理我们全部介绍完毕。我们整个队。

GPIO的输入引脚检测到电平的变化，并和EXTI的边沿检测电路进行对比，当检测到你设置的触发条件，EXTI会认为这是一次有效的中断触发，并置位对应的挂起标志（EXTI_PR寄存器中的位会被置1），也就是“记录”中断发生了，还没有真正执行中断服务程序(NVIC).然后EXTI 把中断“申请”交给了NVIC。NVIC再检查你配置的这个中断线（比如 EXTI0_IRQn）是否已启用？是否结构体初始化NVIC_Init()？是否NVIC_IQNchannel是否ENABLE? NVIC再根据当前是否有别的中断在执行、优先级是否更高，来决定马上进入中断服务程序（ISR），还是等其他更高优先级中断执行完再处理。

下面我们开始利用中断编写一个程序--按下按键即为中断，在中断函数中使得LED灯的颜发生变化。

首先，配置NVIC及其相关寄存器

1.确定抢占优先级和子优先级的分组
![image](https://github.com/user-attachments/assets/eed9ed0b-595f-48f4-bb11-04d7eda5f0ea)

2.初始化结构体并按着要求配置
![image](https://github.com/user-attachments/assets/9aaa30cb-3652-4343-8368-9a134bc95ba4)
这里我相信大家NVIC_IRQChannelCmd(启用或者禁止中断通道)，NVIC_IRQChannelPreemptionPriority(配置抢占优先级大小)和NVIC_IRQChannelSubPriority(配置子优先级的大小)大家应该都没有问题，最大的问题可能是NVIC_IRQChannel(配置哪个要中断)，这里我着重讲一下这个。

NVIC_IRQChannel：

