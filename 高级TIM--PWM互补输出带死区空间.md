  高级TIM所谓高级，就是它除了能实现基本的定时功能以外，还能测量脉宽和频率，以及生成PWM信号。

  这一节我先讲解高级TIM生成PWM信号的基本原理。

  先附上一张高级控制定时器框图
  ![image](https://github.com/user-attachments/assets/88909f36-0a20-449c-979c-4c4cdebf05fc)

  严重怀疑这张图就是防止初学者看懂......

  我按我自己的方式讲出来。

  首先，51单片机玩过吧，还记得51单片机是如何控制引脚输出PWM信号实现呼吸灯的吗？

  不记得了的话我附上我当时写的51单片机的PWM程序

      #include<REGX52.H>
      #include"time.h"
      sbit Motor=P1^0;
      unsigned char Compare;
      void main()
      {
      	unsigned char Speed=0;
      	unsigned char Key=0;
      	time0_Init();
      	while(1)
      	{
      		Key=Keyboard();
      		if(Key)
      		{
      			Speed++;
      			Speed%=4;
      			if(Speed==0)
      			{
      				Compare=0;
      			}
      			if(Speed==1)
      			{
      				Compare=50;
      			}
      			if(Speed==2)
      			{
      				Compare=75;
      			}
      			if(Speed==3)
      			{
      				Compare=100;
      			}
      			
      		}
      		Nixie_Set(1,Speed);
      	}
      }
      
      void Time0()  interrupt 3
      {
      	static unsigned int count1=0,count2=0,count3=0;
      	TL0 = 0x9C;		//设置定时初值
      	TH0 = 0xFF;
      	count1++;
      	count2++;
      	count3++;
      	count3%=100;
      	if(count3<Compare)
      	{
      		Motor=1;
      	}
      	else
      	{
      		Motor=0 ;
      	}
      }


  你看，我是令了P1^0引脚为Motor，作为输出PWM信号的引脚。然后我设定了一个定时器，让定时器每隔一段时间就进入一次中断，让count3++;然后当count3满足一定条件后将P1^0翻转以模拟PWM信号。
  
  所以，51单片机生成PWM的信号的方式是软件手动调整的！而stm32的高级TIM就高级在这里，我完全可以不需要手动，我直接通过硬件就可以生成出PWM信号，而且还更加精准！

  那么，stm32是如何产生PWM信号的呢？

  首先是个定时器就得有个时钟吧，高级TIM和基本TIM的在区别之一是高级TIM有更多的时钟源可以选择。

  时钟源：

    1.内部时钟CK_INT：对应的是图的最上方，来自芯片内部，等于72MHZ，一般情况下我们都用内部时钟
    2.外部时钟模式1：对应的是图的最左侧的TIMx_CHy(x为其他定时器的型号，y=1,2,3,4),简称TIx(x=1,2,3,4)。
    也就是说，高级定时器的时钟源可以由其他定时器的输出情况来提供。
    ![image](https://github.com/user-attachments/assets/4c9755f9-b2ba-47be-a1aa-58aafbfc4cd0)

    这幅图为外部时钟模式1的工作流程图。其大致的意思是
        1.从TIMx_CHy来的信号可以先经过滤波器进行重新采样
        2.然后选择是上升沿有效还是下降沿有效
        3.然后根据你选择的信号源去选择触发源(你可以理解为让时钟源搭在定时器的时钟上)(例如你选的是CH1作为信号源，则这里应该选择定时器输入 1（TI1FP1）)
        4.最后配置从模式(即配置时钟源的模式，例如这里你选的是外部时钟模式1，那么这里就选择模式为"外部时钟模式1")

    观察可以发现，前俩步是在处理外部信号源，后俩步是在告诉高级TIM我选的信号源是哪一个，时钟模式是哪一个。然后高级TIM就会按照对应的要求去工作。

    3.外部时钟模式2：对应的是图的左上侧的TIMx_ETR，这个引脚信号的来源是其他设备（如传感器、信号发生器、另一片MCU）的输出引脚；
    STM32内部另一个定时器的触发输出（TRGO）；通过外部中断引脚（如EXTI）触发，再路由到ETR等。
    
      相比于外部时钟模式1，其优点在于：
        1.需要将定时器作为高频计数器（如测量高频脉冲、频率计）时，ETR引脚支持更高频率（通常比TI1/TI2引脚更抗干扰）。
        2.在系统需要隔离的独立时钟源时，ETR引脚与TI1/TI2完全独立，避免信号冲突。
        3.在抗干扰要求高的环境，ETR引脚通常具有更好的噪声抑制特性。可配置强滤波（ETRF位域）滤除毛刺。
        4.用于多个定时器需要严格同步（如并联的PWM发生器）。
      ![image](https://github.com/user-attachments/assets/e576adc3-2cf5-4412-a4b3-36d672e55590)

    这是外部时钟模式2的工作流程图，其大致的意思是
        1.信号从ETR引脚引进来后，选择是上升沿有效还是下降沿有效
        2.可以选择分频
        3.可以对信号进行滤波
        4.使能计时器即可

      相比外部时钟模式1，外部时钟模式2不用配置选择触发源和信号源，这是它相比于前者更加方便的原因

    4.内部触发输入：也就是图中上侧的ITRx，是使用一个定时器作为另一个定时器的预分频器。硬件上高级控制定时器和通用定时器在内部连接在一起，
    可以实现定时器同步或级联。比较少用，了解即可。

    

        

    

  

  
