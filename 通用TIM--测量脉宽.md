  这一节主要讲解捕获寄存器

  根据之前的了解，我们已知通用TIM和高级TIM有输入捕获/互补输出的功能。这里附上一张输入捕获的流程示意图：

  ![image](https://github.com/user-attachments/assets/b1806d47-c393-4db6-b3cd-f7ccca6a9924)

  输入捕获的原理很简单，信号从输入引脚(TIMx_CHy)进来，经过滤波和预分频后，如果信号达到触发源设置的条件，计数器(CNT)会把当前的值存入捕获寄存器(CCR)中，我们把前后俩次存储的值读出来，然后作差，我们就可以算出一个值。我们就可以利用信号总会有上升沿和下降沿的特性，去测量一个信号的脉宽或者频率。

  那么程序上如何实现计算时间？我们可以利用捕获寄存器可以生成中断，，当捕获寄存器捕获到数据时,进到中断里面把数据读取出来，然后等第二次捕获到数据时再进去一次中断，再取出来，然后讲俩个值做差，理论上就可以得到脉宽或者频率的值。

  但实际上只是这样操作的话存在一些问题，如果脉宽/频率的时间超出了计数器的计数值，计数器数到头了直接重来了，计算的差值不久是错的吗。所以我们不仅仅需要开启捕获寄存器的中断，还要开启计数器的中断，当计数器完成一个计数周期时，用一个变量记录一下，后面算脉宽/频率时一起加起来。

  现在介绍一下输入捕获的原理图：

      1.输入通道(TIMx_CHy):要测量的信号从这里进入
      2.边缘检测器：这里你可以配置上升沿有效还是下降沿有效，只有检测到有效边沿，计数器才会把数值存入捕获计数器
      3.输入滤波器：这里可以输入0xF(4位值)，数值越高，越有利于剔除毛刺。工作原理：滤波器会对输入信号进行采样，
      只有当连续多个采样点都保持一致时，才认为是有效边沿。例如，设置为 0x03 表示需要连续 3 个采样点都一致才触发捕获
      
      4.捕获通道(ICx)：当信号中的边沿被检测到有效时，就会从输入滤波器和边沿检测器经过TIxFPy到达捕获通道。
      这里我们可以看见的是，例如从输入通道(CH1)进来的即可以流向IC1(经过TI1FP1),也可以流向CI2(TI1FP2)。
      也就是说，我既可以单独测脉宽或频率，也可以同时进行测量。同时测量常用于测PWM信号的频率和脉宽
      
      5.ICx 的输出信号会经过一个预分频器，用于决定发生多少个事件时进行一次捕获。具体的由寄存
      器 CCMRx 的位 ICxPSC 配置，如果希望捕获信号的每一个边沿，则不分频。(注意：这个不同与时基内部的PSC)

      6.捕获寄存器：最终有效信号触发计时器CNT向捕获寄存器存入当前值。
      当发生捕获时（第一次），还会产生 CCxI 中断，通过软件或者读取 CCR 中的值可以将 CCxIF 清 0。
      如果发生第二次捕获（即重复捕获），则捕获溢出标志位 CCxOF会被置位，CCxOF 只能通过软件清零。


  了解了大致的工作流程，现在讲解捕获结构体的成员

      1.TIM_Channel：指定使用的定时器输入通道。
      2.TIM_ICPolarity：指定输入捕获的边沿触发极性。
      注意：通用TIM没有双边沿触发（同时捕获上升沿和下降沿），只有高级TIM有

      3.TIM_ICSelection：指定输入捕获的信号源连接方式。
      TIM_ICSelection_DirectTI：直接连接模式，捕获信号直接来自对应的定时器通道（如 TIMx_CH1 连接到 IC1）。
      TIM_ICSelection_IndirectTI：间接连接模式，捕获信号来自另一个通道（如 TIMx_CH2 连接到 IC1）。常用于测量两个信号之间的相位差。
      TIM_ICSelection_TRC：触发连接模式，捕获信号来自定时器的触发输入（TRC）。

      4.TIM_ICPrescaler：指定输入捕获的预分频器值，用于控制捕获事件的采样频率。

      5.TIM_ICFilter：指定输入捕获的数字滤波器长度，用于消除输入信号中的噪声干扰。取值范围：0x0~0xF（4 位值）

  配置完通用TIM，NVIC,GPIO，清楚标志位，开启中断通道，使能DMA即可。计算脉宽的逻辑看中断头文件。

  如果你想用DMA的话，其实也没什么问题，还是老步骤，配置DMA,在使能TIM前开启DMA通道和使能DMA即可。

  但是stm32f103没有DMA2，TIM5是连接到DMA2的，所以无法用DMA,这里只是一个示范。并且在stm32f103开发板中TIMx_CH1已经连接到了PA0，所以我们只能做按下K1按键测量脉宽的实验。
